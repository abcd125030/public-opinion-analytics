# 舆情分析功能介绍

**目标与场景**
- 面向品牌“霸王茶姬”的舆情监测与判别，支持文本与图片联合分析
- 将用户内容归类为「类别1 负面客诉」「类别2 数据泄露风险」「类别3 黑灰产/薅羊毛」「类别4 代下单」或「其他」

**功能概览**
- 文本+图片联合：先对图片进行简要内容提取，再与原始文本拼接进行判别（见 [analysis_service.py](file:///d:/20260115-大模型使用-讲课内容/大模型使用案例/舆情分析/analysis_service.py) 的 process_images）
- 规则+案例对齐：内置判定规则与大量参考案例用于对齐输出风格（见 [dict_example.json](file:///d:/20260115-大模型使用-讲课内容/大模型使用案例/舆情分析/dict_example.json)）
- 标准化结果：统一输出 JSON，包含“结论”“原因”，聚焦事实与关键实体信息
- 模型封装清晰：文本模型与多模态视觉模型调用独立封装（见 [llm_new.py](file:///d:/20260115-大模型使用-讲课内容/大模型使用案例/舆情分析/llm_new.py)）

**输入与输出**
- 输入载荷

```json
{
  "content": "用户发布的文字内容",
  "im_body": ["https://example.com/a.jpg", "https://example.com/b.png"]
}
```

- 正常输出（模型内容为字符串形式的 JSON）

```json
{
  "结论": "类别1|类别2|类别3|类别4|其他",
  "原因": "简洁清晰的解释（≤100字）"
}
```

- 异常输出

```json
{ "error": "舆情分析流程异常: ......" }
```

**判定流程**
- 处理图片：调用视觉模型提取图片摘要，附加到文本（[analysis_service.py](file:///d:/20260115-大模型使用-讲课内容/大模型使用案例/舆情分析/analysis_service.py#L6-L24)）
- 构造提示词：加载参考案例，拼接判定规则与格式要求（[analysis_service.py](file:///d:/20260115-大模型使用-讲课内容/大模型使用案例/舆情分析/analysis_service.py#L48-L139)）
- 模型判别：向文本模型发送消息，获得判定结果（[analysis_service.py](file:///d:/20260115-大模型使用-讲课内容/大模型使用案例/舆情分析/analysis_service.py#L27-L45)；[llm_new.py](file:///d:/20260115-大模型使用-讲课内容/大模型使用案例/舆情分析/llm_new.py#L10-L115)）
- 封装返回：统一结构化输出，便于程序消费（choices.message.content）

**类别与规则（摘要）**
- 类别1 负面客诉：对产品/服务表达不满、投诉、差评等
- 类别2 数据泄露风险：涉及未授权访问、隐私外泄、敏感信息暴露
- 类别3 黑灰产/薅羊毛：工具/脚本不当获利、绕过风控、刷量等
- 类别4 代下单：代替他人下单/核销/兑码等交易行为
- 其他：不属于以上类别并说明原因（要求客观、基于事实）

**参考案例库**
- 文件：[dict_example.json](file:///d:/20260115-大模型使用-讲课内容/大模型使用案例/舆情分析/dict_example.json)
- 结构：每个案例包含「示例输入」「结论」「原因」，用于对齐模型输出与边界

**运行指南**
- 准备环境（参考 [README.md](file:///d:/20260115-大模型使用-讲课内容/大模型使用案例/舆情分析/README.md)）
  - 创建并激活虚拟环境：`python -m venv .venv`，Windows：`.venv\\Scripts\\activate`
  - 升级 pip：`python -m pip install --upgrade pip`
  - 安装依赖：`pip install -r requirements.txt`
- 设置密钥
  - 在项目根目录创建或编辑 `.env`，添加 `DASHSCOPE_API_KEY=你的密钥`（请勿泄露密钥值）
- 运行示例
  - 执行：`python analysis_service.py`
  - 程序会对内置样例进行判别并打印结果（见 [analysis_service.py](file:///d:/20260115-大模型使用-讲课内容/大模型使用案例/舆情分析/analysis_service.py#L142-L157)）

**依赖与外部服务**
- Python 依赖：requests、loguru、python-dotenv（见 [requirements.txt](file:///d:/20260115-大模型使用-讲课内容/大模型使用案例/舆情分析/requirements.txt)）
- 外部服务：阿里云 DashScope Chat Completions API
  - 文本模型：`qwen3-235b-a22b`（支持流式/非流式返回）
  - 视觉模型：`qwen-vl-max-latest`（对图片进行简要描述）

**提示词构造（函数输出示例）**
- 以下为 make_content_prompt 基于示例输入生成的输出文本（参考案例为节选；完整案例请见 dict_example.json）。示例输入：5r 霸王茶姬买一送一 代下单#霸王茶姬新品##奶茶推荐#

你现在是一个专业的舆情分析专家，专注于识别和分类文字内容中的舆情信息。请根据以下类别规则，对输入的文字内容进行判断，并给出明确结论。

<judge_rules>
类别 1：负面的舆情客诉信息，负面评价
    定义：用户针对产品、服务等表达不满、投诉或批评的内容。
    示例：抱怨服务质量差、产品有问题、体验不佳等。

类别 2：数据泄露风险
    定义：文字中提及数据被非法获取、不当传播、隐私泄露等相关内容。
    示例：提到系统漏洞导致信息泄露、个人隐私被公开、未经授权的数据访问等。

类别 3：黑灰产信息（工具开发，薅羊毛）
    定义：涉及利用工具、技术或手段非法获利、不正当获取利益的行为。
    示例：讨论如何利用漏洞获利、制作或销售作弊工具、薅取平台福利等。

类别 4：代下单
    定义：免费或者收费给予他人优惠券或者可指定地方下单自取，代替他人进行商品或服务下单的行为。
    示例：为他人代下单，并在宣传中诱导消费者参与，借助此行为薅取商家及平台推出的优惠福利。
    
其他：不属于上述任何类别
</judge_rules>

如果文字内容与上述四类无关，请明确指出原因。

<task_requirements>
    - 根据分析规则，明确指出这段文字属于哪个类别。
    - 若属于某类别，请简要说明原因（每条原因不超过 100 字）。
    - 若都不属于，请说明具体原因。
</task_requirements>

<reference_case_for_align_to>
    <reference_case_1>
        需要甄别的内容：
        ```
        在某门店点的奶茶有明显异味，客服一直推诿不处理，退款也拖了两天，体验非常差。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "包含对产品/服务的不满、投诉与负面评价，属于负面舆情客诉。",
        }
        ```
    </reference_case_1>

    <reference_case_2>
        需要甄别的内容：
        ```
        该小程序接口未做鉴权，通过抓包即可查询任意手机号的订单详情，用户隐私有泄露风险，请尽快修复。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别2",
            "原因": "明确提及未经授权的数据访问与隐私泄露风险，符合数据泄露风险。",
        }
        ```
    </reference_case_2>

    <reference_case_3>
        需要甄别的内容：
        ```
        有脚本可自动刷平台优惠券，循环领码不受次数限制，配套改机教程和工具出售，低成本薅平台福利。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别3",
            "原因": "涉及工具/脚本非法获利与薅羊毛操作，符合黑灰产信息。",
        }
        ```
    </reference_case_3>

    <reference_case_4>
        需要甄别的内容：
        ```
        14.9➗茶百道大杯券 可代下/兑码，指定门店自取，需提前30分钟下单；异地可加2元服务费。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别4",
            "原因": "提供代替他人下单并诱导参与的优惠券交易，属于代下单。",
        }
        ```
    </reference_case_4>

    <reference_case_5>
        需要甄别的内容：
        ```
        到店自取等了40分钟还做错单，两次返工，体验极差。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "制作错误与等待过久引发投诉，属负面客诉。",
        }
        ```
    </reference_case_5>

    <reference_case_6>
        需要甄别的内容：
        ```
        珍珠硬到咬不动，客服只让我换一杯不退款，很不满意。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "产品质量问题导致不满，属负面客诉。",
        }
        ```
    </reference_case_6>

    <reference_case_7>
        需要甄别的内容：
        ```
        线上备注去糖被忽略，做成全糖，饮用后不适。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "制作未按要求，造成不适，负面客诉。",
        }
        ```
    </reference_case_7>

    <reference_case_8>
        需要甄别的内容：
        ```
        门店卫生差，桌面黏腻且垃圾未清理，影响用餐体验。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "环境卫生差引发批评，负面客诉。",
        }
        ```
    </reference_case_8>

    <reference_case_9>
        需要甄别的内容：
        ```
        活动写买一送一，到店却说已结束，感觉被欺骗。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "宣传与实际不符，引发不满，负面客诉。",
        }
        ```
    </reference_case_9>

    <reference_case_10>
        需要甄别的内容：
        ```
        点热饮却给了冰饮，店员态度敷衍不愿重做。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "服务态度与制作错误，负面客诉。",
        }
        ```
    </reference_case_10>

    <reference_case_11>
        需要甄别的内容：
        ```
        送餐严重延误，奶盖化了，口感变差，拒绝重做。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "延误影响品质，引发投诉，负面客诉。",
        }
        ```
    </reference_case_11>

    <reference_case_12>
        需要甄别的内容：
        ```
        门店收错款，多收了5元，申诉无回应。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "价格异常与售后不响应，负面客诉。",
        }
        ```
    </reference_case_12>

    <reference_case_13>
        需要甄别的内容：
        ```
        会员券无法使用，系统报错，客服只说“稍后再试”。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "功能异常影响使用，引发不满，负面客诉。",
        }
        ```
    </reference_case_13>

    <reference_case_14>
        需要甄别的内容：
        ```
        奶茶有漂白水味，怀疑原料问题，店家不承认。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "疑似食品安全问题，引发投诉，负面客诉。",
        }
        ```
    </reference_case_14>

    <reference_case_15>
        需要甄别的内容：
        ```
        排队被插队，店员不处理，秩序混乱。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "管理不当造成体验差，负面客诉。",
        }
        ```
    </reference_case_15>

    <reference_case_16>
        需要甄别的内容：
        ```
        退款申请超过72小时未到账，沟通无结果。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "退款拖延，售后不佳，负面客诉。",
        }
        ```
    </reference_case_16>

    <reference_case_17>
        需要甄别的内容：
        ```
        外卖少了配料，商家让我自己联系平台，推诿。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "缺少商品与推诿处理，负面客诉。",
        }
        ```
    </reference_case_17>

    <reference_case_18>
        需要甄别的内容：
        ```
        打烊前半小时拒接单，页面仍显示营业中。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "运营信息不一致，引发不满，负面客诉。",
        }
        ```
    </reference_case_18>

    <reference_case_19>
        需要甄别的内容：
        ```
        纸杯破损渗漏，手上全是饮品，影响心情。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "包装质量问题导致投诉，负面客诉。",
        }
        ```
    </reference_case_19>

    <reference_case_20>
        需要甄别的内容：
        ```
        小程序下单后门店找不到订单，让我重新付款。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "系统与门店对接异常，负面客诉。",
        }
        ```
    </reference_case_20>

    <reference_case_21>
        需要甄别的内容：
        ```
        店员聊天不接待，叫了三次没人理，体验差。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "服务不周与态度问题，负面客诉。",
        }
        ```
    </reference_case_21>

    <reference_case_22>
        需要甄别的内容：
        ```
        买到了过期糕点，店家只愿意换不愿退款。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "过期食品引发不满，负面客诉。",
        }
        ```
    </reference_case_22>

    <reference_case_23>
        需要甄别的内容：
        ```
        发票开错抬头，要求重开被拒，影响报销。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "售后处理不当，负面客诉。",
        }
        ```
    </reference_case_23>

    <reference_case_24>
        需要甄别的内容：
        ```
        连锁店标准不一，这家味道明显偏淡，失望。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别1",
            "原因": "品质不稳定导致差评，负面客诉。",
        }
        ```
    </reference_case_24>

    <reference_case_25>
        需要甄别的内容：
        ```
        公开的日志接口返回订单手机号与地址信息。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别2",
            "原因": "未鉴权接口暴露隐私数据，数据泄露风险。",
        }
        ```
    </reference_case_25>

    <reference_case_26>
        需要甄别的内容：
        ```
        分享链接包含token参数，转发即泄露账号。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别2",
            "原因": "敏感凭证暴露，存在未授权访问风险。",
        }
        ```
    </reference_case_26>

    <reference_case_27>
        需要甄别的内容：
        ```
        对象存储桶可匿名浏览下载用户照片与小票。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别2",
            "原因": "存储未鉴权导致隐私外泄，数据泄露风险。",
        }
        ```
    </reference_case_27>

    <reference_case_28>
        需要甄别的内容：
        ```
        订单详情接口可按自增ID遍历他人信息。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别2",
            "原因": "IDOR漏洞可获取他人数据，数据泄露风险。",
        }
        ```
    </reference_case_28>

    <reference_case_29>
        需要甄别的内容：
        ```
        二维码内容含明文姓名+手机号，随拍即泄。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别2",
            "原因": "敏感信息明文展示，隐私泄露风险。",
        }
        ```
    </reference_case_29>

    <reference_case_30>
        需要甄别的内容：
        ```
        后台弱口令admin123，外网可访问。
        ```
        实际甄别的输出结果：
        ```
        {
            "结论": "类别2",
            "原因": "弱口令与未授权访问，数据泄露风险。",
        }
        ```
    </reference_case_30>

    ……（其余参考案例略，完整内容请查看 dict_example.json）
</reference_case_for_align_to>
        
以下是你要甄别的文本内容：
5r 霸王茶姬买一送一 代下单#霸王茶姬新品##奶茶推荐#

<judge_result_format_requirements>
"结论"options = ["类别1", "类别2", "类别3", "类别4",  "其他"]

"原因"rules = "简洁清晰的解释"
</judge_result_format_requirements>

仅允许且必须按照如下格式输出(具体内容仅作示例)：
```
{
    "结论": "类别1",
    "原因": "用户投诉奶茶饮用后出现身体不适症状（恶心、发烧、腹泻），属于负面客诉信息。"
}
```

